<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>Bảng Xếp Hạng</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
</head>

<div layout:fragment="content">

    <div class="page-header">
        <h1>Bảng Xếp Hạng</h1>
    </div>

    <div class="filter-bar" style="display: flex; justify-content: space-between; align-items: center;">

        <div style="display: flex; gap: 10px;">
            <button class="filter-select active-mode" id="btn-day" onclick="changeMode('DAY')">Hôm nay</button>
            <button class="filter-select" id="btn-week" onclick="changeMode('WEEK')">Tuần này</button>
            <button class="filter-select" id="btn-month" onclick="changeMode('MONTH')">Tháng này</button>
        </div>

        <div>
            <select id="genre-select" class="filter-select" onchange="loadRanking()">
                <option value="">Tất cả thể loại</option>
            </select>
        </div>
    </div>

    <div class="songs-table-container">
        <table class="songs-table">
            <thead>
            <tr>
                <th class="col-number">Hạng</th> <th class="col-title">Bài hát</th>
                <th class="col-artist">Nghệ sĩ</th>
                <th class="col-views">Lượt nghe</th>
                <th class="col-album">Nghe</th> </tr>
            </thead>
            <tbody id="ranking-list-body">
            <tr><td colspan="5" style="text-align: center; padding: 30px;">Đang tải...</td></tr>
            </tbody>
        </table>
    </div>
</div>

<th:block layout:fragment="extra-css">
    <style>
        /* 1. Ẩn thanh music player */
        #musicPlayer {
            display: none !important;
        }

        /* 2. Xóa khoảng trống thừa dưới chân trang (do layout gốc để chừa chỗ cho player) */
        body {
            padding-bottom: 0 !important;
        }
        /* --- COPY CSS TỪ LIST.HTML SANG --- */
        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #050505;
            /* Hiệu ứng nền xanh/đen */
            background-image:
                    radial-gradient(at 0% 0%, rgba(1, 109, 110, 0.3) 0px, transparent 50%),
                    radial-gradient(at 100% 0%, rgba(1, 60, 60, 0.5) 0px, transparent 50%),
                    radial-gradient(at 50% 50%, rgba(255, 255, 255, 0.02) 0px, transparent 50%);
            background-attachment: fixed;
            background-size: 100% 100%;
            min-height: 100vh;
            color: white;
        }

        .page-header { margin-bottom: 2rem; }
        .page-header h1 { font-size: 2.5rem; color: #E0FFFF; font-weight: 700; text-transform: uppercase; letter-spacing: 2px; }

        /* Style cho thanh Filter */
        .filter-bar {
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(10px);
            padding: 1rem 1.5rem;
            border-radius: 16px;
            margin-bottom: 2rem;
            border: 1px solid rgba(224, 255, 255, 0.1);
        }

        .filter-select {
            padding: 0.6rem 1.2rem;
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 206, 209, 0.3);
            border-radius: 100px;
            color: #E0FFFF;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: 0.3s;
        }
        .filter-select:hover, .filter-select:focus {
            background: rgba(0, 206, 209, 0.2);
            border-color: #00CED1;
            outline: none;
        }
        .filter-select option { background: #000; color: white; }

        /* Class riêng cho nút đang Active (Day/Week/Month) */
        .active-mode {
            background: #00CED1 !important;
            color: black !important;
            box-shadow: 0 0 10px rgba(0, 206, 209, 0.5);
        }

        /* Style Bảng (Table) */
        .songs-table-container {
            background: rgba(0, 0, 0, 0.4);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(224, 255, 255, 0.1);
        }
        .songs-table { width: 100%; border-collapse: collapse; }
        .songs-table thead { background: rgba(0, 0, 0, 0.5); border-bottom: 1px solid rgba(224, 255, 255, 0.1); }
        .songs-table th { padding: 1rem 1.5rem; text-align: left; color: rgba(224, 255, 255, 0.6); text-transform: uppercase; font-size: 0.85rem; }
        .songs-table td { padding: 1rem 1.5rem; color: #E0FFFF; vertical-align: middle; border-bottom: 1px solid rgba(224, 255, 255, 0.05); }
        .songs-table tbody tr:hover { background: rgba(0, 206, 209, 0.1); }

        /* Cột Tiêu đề bài hát */
        .title-cell { display: flex; align-items: center; gap: 1rem; }
        .song-cover { width: 50px; height: 50px; border-radius: 8px; overflow: hidden; position: relative; cursor: pointer; }
        .song-cover img { width: 100%; height: 100%; object-fit: cover; }

        .song-name { font-weight: bold; font-size: 1rem; color: white; display: block; margin-bottom: 4px; text-decoration: none; }
        .song-name:hover { color: #00CED1; }

        /* Hiệu ứng Play Overlay giống list.html */
        .song-cover { position: relative; overflow: hidden; cursor: pointer; }
        .play-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.4); display: flex; align-items: center; justify-content: center;
            opacity: 0; transition: 0.3s; backdrop-filter: blur(2px);
        }
        .song-cover:hover .play-overlay { opacity: 1; }
        .play-overlay i { color: white; font-size: 1.2rem; text-shadow: 0 0 10px white; }

        /* Link bài hát */
        .song-link { color: white; text-decoration: none; transition: 0.2s; }
        .song-link:hover { color: #00f3ff; text-decoration: underline; }

        /* --- STYLE ĐẶC BIỆT CHO TOP 1, 2, 3 --- */
        .rank-num { font-size: 1.5rem; font-weight: bold; color: rgba(255,255,255,0.5); text-align: center; width: 40px; display: inline-block; }

        .top-1 .rank-num { color: #FFD700; text-shadow: 0 0 15px rgba(255, 215, 0, 0.6); font-size: 2rem; } /* Vàng */
        .top-2 .rank-num { color: #C0C0C0; text-shadow: 0 0 10px rgba(192, 192, 192, 0.5); font-size: 1.8rem; } /* Bạc */
        .top-3 .rank-num { color: #CD7F32; text-shadow: 0 0 10px rgba(205, 127, 50, 0.5); font-size: 1.6rem; } /* Đồng */

        .view-count { color: #00CED1; font-weight: bold; font-family: monospace; font-size: 1.1rem; }

        .play-btn-sm {
            width: 35px; height: 35px; border-radius: 50%;
            background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2);
            color: white; display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.2s;
        }
        .play-btn-sm:hover { background: #00CED1; color: black; border-color: #00CED1; transform: scale(1.1); }
    </style>
</th:block>

<th:block layout:fragment="extra-js">
    <script>
        const API = '/api'; // Hoặc đường dẫn API của bạn
        let currentMode = 'DAY';
        let rankingDataList = []; // Lưu trữ danh sách bài hát

        // 1. Load danh sách thể loại
        async function loadGenres() {
            try {
                // Giả lập hoặc gọi API thật
                const res = await fetch('/genres/api/all');

                if (!res.ok) throw new Error("Lỗi HTTP: " + res.status); // Bắt lỗi 403/404
                // Nếu API trả về mảng genre
                const genres = await res.json();
                const sel = document.getElementById('genre-select');
                // Reset lại option để tránh bị duplicate nếu gọi nhiều lần
                sel.innerHTML = '<option value="">Tất cả thể loại</option>';

                genres.forEach(g => {
                    sel.innerHTML += `<option value="${g.genreId}">${g.name}</option>`;
                });
            } catch(e) {
                console.log("Không load được genre: ", e);
            }
        }

        // 2. Load bảng xếp hạng (RENDER DẠNG TABLE)
        async function loadRanking() {
            const genreId = document.getElementById('genre-select').value;
            const tbody = document.getElementById('ranking-list-body');

            // Hiện loading
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px;"><i class="fas fa-spinner fa-spin"></i> Đang tải dữ liệu...</td></tr>';

            // Tạo URL
            let url = `/ranking/data?mode=${currentMode}`;
            if(genreId) url += `&genreId=${genreId}`;

            try {
                const res = await fetch(url);
                if (!res.ok) throw new Error("Lỗi HTTP: " + res.status); // Bắt lỗi
                const data = await res.json();
                rankingDataList = data; // Lưu dữ liệu vào biến toàn cục

                tbody.innerHTML = ''; // Xóa loading

                if(!data || data.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" class="text-center" style="padding:30px; color:#888;">Chưa có dữ liệu cho bảng xếp hạng này.</td></tr>';
                    return;
                }

                // Render từng dòng (Row) thay vì Card
                data.forEach((item, index) => {
                    const s = item.song;
                    const rank = index + 1;
                    const topClass = rank <= 3 ? `top-${rank}` : ''; // Class để tô màu top 1,2,3

                    // Format số view (VD: 1000 -> 1,000)
                    const viewsFormatted = new Intl.NumberFormat().format(item.plays);

                    // Xử lý an toàn dữ liệu nếu thiếu
                    const artistName = s.artist ? s.artist.name : 'Unknown Artist';
                    const songImg = s.coverImage || '/images/default.png';
                    const songLink = `/songs/${s.songId}`; // Link tới trang chi tiết

                    // Dùng playRankingSong(${index}) thay vì truyền chuỗi trực tiếp
                    const tr = `
                <tr class="${topClass}">
                    <td class="col-number"><span class="rank-num">${rank}</span></td>
                    <td class="col-title">
                        <div class="title-cell">
                            <div class="song-cover" onclick="playRankingSong(${index})">
                                <img src="${songImg}" alt="cover">
                                <div class="play-overlay"><i class="fas fa-play"></i></div>
                            </div>
                            <div>
                                <a href="/songs/${s.songId}" class="song-name song-link">${s.title}</a>
                            </div>
                        </div>
                    </td>
                    <td class="col-artist text-secondary">${artistName}</td>
                    <td class="col-views"><span class="view-count">${viewsFormatted}</span></td>
                    <td class="col-album">
                         <button class="play-btn-sm" onclick="playRankingSong(${index})">
                            <i class="fas fa-play"></i>
                         </button>
                    </td>
                </tr>`;
                    tbody.innerHTML += tr;
                });

            } catch(e) {
                console.error(e);
                tbody.innerHTML = '<tr><td colspan="5" class="text-center text-danger">Lỗi tải dữ liệu.</td></tr>';
            }
        }

        // HÀM PHÁT NHẠC MỚI (An toàn hơn)
        function playRankingSong(index) {
            if (!rankingDataList[index]) return;
            const item = rankingDataList[index];
            const s = item.song;
            // Gọi hàm global trong layout.html
            playGlobalSong(s.filePath, s.title, s.artist ? s.artist.name : 'Unknown', s.coverImage);
        }

        function changeMode(mode) {
            currentMode = mode;
            document.querySelectorAll('.filter-bar button').forEach(btn => btn.classList.remove('active-mode'));
            if(mode === 'DAY') document.getElementById('btn-day').classList.add('active-mode');
            if(mode === 'WEEK') document.getElementById('btn-week').classList.add('active-mode');
            if(mode === 'MONTH') document.getElementById('btn-month').classList.add('active-mode');
            loadRanking();
        }

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            loadGenres();
            loadRanking();
        });
    </script>
</th:block>
</html>