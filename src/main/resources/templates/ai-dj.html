<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout}">
<head>
    <title>AI DJ - MusicPro</title>
</head>

<th:block layout:fragment="extra-css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

    <style>
        /* 1. ·∫®n thanh music player */
        #musicPlayer {
            display: none !important;
        }

        /* 2. X√≥a kho·∫£ng tr·ªëng th·ª´a d∆∞·ªõi ch√¢n trang (do layout g·ªëc ƒë·ªÉ ch·ª´a ch·ªó cho player) */
        body {
            padding-bottom: 0 !important;
        }
        /* Reset ƒë√® style c·ªßa layout ƒë·ªÉ kh√¥ng b·ªã v·ª° */
        .ai-wrapper {
            font-family: 'Segoe UI', sans-serif;
            color: white;
            background-color: transparent; /* N·ªÅn trong su·ªët ƒë·ªÉ ƒÉn theo layout */
        }
        :root {
            --primary: #00f3ff;
            --bg-dark: #0a0a0a;
            --bg-sidebar: #000000;
            --bg-card: #111111;
            --text-main: #ffffff;
            --text-gray: #b3b3b3;
            --border-color: #333;

            /* K√≠ch th∆∞·ªõc chung */
            --sidebar-width: 250px;
            --player-height: 90px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background-color: #050505;

            /* Hi·ªáu ·ª©ng n·ªÅn c·ªßa b·∫°n (Gi·ªØ nguy√™n) */
            background-image:
                    radial-gradient(at 0% 0%, rgba(1, 109, 110, 0.3) 0px, transparent 50%),
                    radial-gradient(at 100% 0%, rgba(1, 60, 60, 0.5) 0px, transparent 50%),
                    radial-gradient(at 50% 50%, rgba(255, 255, 255, 0.02) 0px, transparent 50%);
            background-attachment: fixed;
            background-size: 100% 100%;

            min-height: 100vh;
            color: white;
        }

        .ai-card { background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%); border: 1px solid #00f3ff; transition: 0.3s; }
        .ai-card:hover { box-shadow: 0 0 20px rgba(0, 243, 255, 0.3); transform: translateY(-5px); }

        .ai-header {
            background: linear-gradient(90deg, #0f3460 0%, #1a1a2e 100%);
            border-radius: 15px;
            padding: 40px;
            margin-bottom: 30px;
            border: 1px solid rgba(0, 243, 255, 0.2);
        }

        .typing-animation { overflow: hidden; border-right: 2px solid #00f3ff; white-space: nowrap; animation: typing 3.5s steps(40, end); }
        @keyframes typing { from { width: 0 } to { width: 100% } }

        .feature-icon { width: 60px; height: 60px; border-radius: 50%; background: rgba(0, 243, 255, 0.1); display: flex; align-items: center; justify-content: center; }

        .mood-btn { transition: all 0.3s; border: 2px solid transparent; margin-bottom: 10px; }
        .mood-btn:hover { transform: translateY(-3px); border-color: #00f3ff; }
        .mood-btn.active { background: #00f3ff !important; color: black !important; border-color: #00f3ff; }

        /* Form Controls ƒë·∫πp h∆°n */
        .form-control, .form-select {
            background-color: #0a0a0a !important;
            border: 1px solid #333 !important;
            color: white !important;
        }
        .form-control:focus, .form-select:focus {
            border-color: #00f3ff !important;
            box-shadow: 0 0 0 0.25rem rgba(0, 243, 255, 0.25) !important;
        }

        /* Star Rating */
        .star-rating i { cursor: pointer; transition: 0.2s; color: #444; }
        .star-rating i.active { color: #ffc107; }

        /* Range Slider Custom */
        .form-range::-webkit-slider-thumb { background: #00f3ff; }

        /* Chat UI */
        .chat-box-container { height: 400px; overflow-y: auto; display: flex; flex-direction: column; gap: 10px; padding: 15px; background: rgba(0,0,0,0.3); border-radius: 8px; }
        .msg { padding: 10px 15px; border-radius: 15px; max-width: 80%; word-wrap: break-word; }
        .msg-user { align-self: flex-end; background: #00f3ff; color: black; border-bottom-right-radius: 2px; }
        .msg-ai { align-self: flex-start; background: #333; color: white; border: 1px solid #444; border-bottom-left-radius: 2px; }

        /* Markdown Style for AI Analysis */
        .analysis-content h3 { color: #00f3ff; font-size: 1.2rem; margin-top: 1rem; }
        .analysis-content ul { padding-left: 20px; }
        .analysis-content li { margin-bottom: 5px; }
    </style>
</th:block>

<div layout:fragment="content" class="ai-wrapper container-fluid py-4">

    <div class="ai-header text-center">
        <h1 class="display-4 fw-bold text-white mb-3">
            <i class="bi bi-robot text-info me-3"></i>AI DJ Th√¥ng Minh
        </h1>
        <p class="fs-5 text-white-50 mb-4">T·∫°o playlist ho√†n h·∫£o theo c·∫£m x√∫c, ho·∫°t ƒë·ªông v√† s·ªü th√≠ch c·ªßa b·∫°n</p>
        <div class="typing-animation d-inline-block">
            <span class="text-info fw-bold fs-5">"Ch√†o b·∫°n! T√¥i l√† DJ AI c·ªßa MusicPro. H√¥m nay b·∫°n mu·ªën nghe g√¨?"</span>
        </div>
    </div>

    <div class="mb-5">
        <h3 class="fw-bold text-white mb-4">
            <i class="bi bi-lightning-charge-fill text-warning me-2"></i>Ch·ªçn nhanh theo t√¢m tr·∫°ng
        </h3>
        <div class="d-flex flex-wrap gap-3 justify-content-center">
            <button class="btn btn-lg mood-btn btn-outline-info" onclick="quickMood('happy')"><i class="bi bi-emoji-smile me-2"></i>Vui v·∫ª</button>
            <button class="btn btn-lg mood-btn btn-outline-success" onclick="quickMood('chill')"><i class="bi bi-tree me-2"></i>Th∆∞ gi√£n</button>
            <button class="btn btn-lg mood-btn btn-outline-warning" onclick="quickMood('energetic')"><i class="bi bi-lightning me-2"></i>NƒÉng l∆∞·ª£ng</button>
            <button class="btn btn-lg mood-btn btn-outline-primary" onclick="quickMood('focus')"><i class="bi bi-laptop me-2"></i>T·∫≠p trung</button>
            <button class="btn btn-lg mood-btn btn-outline-danger" onclick="quickMood('romantic')"><i class="bi bi-heart me-2"></i>L√£ng m·∫°n</button>
            <button class="btn btn-lg mood-btn btn-outline-light" onclick="quickMood('workout')"><i class="bi bi-activity me-2"></i>T·∫≠p gym</button>
        </div>
    </div>

    <div class="row g-4 mb-5">
        <div class="col-md-4">
            <div class="ai-card p-4 rounded-3 h-100 text-center">
                <div class="feature-icon mb-3 mx-auto"><i class="bi bi-magic text-info fs-2"></i></div>
                <h4 class="fw-bold text-white mb-3">T·∫°o Playlist Th√¥ng Minh</h4>
                <p class="text-white-50">T√πy ch·ªânh s√¢u: Genre, BPM, NƒÉm ph√°t h√†nh...</p>
                <button class="btn btn-info w-100 mt-3" onclick="openAdvancedModal()"><i class="bi bi-sliders me-2"></i>Kh·ªüi t·∫°o</button>
            </div>
        </div>
        <div class="col-md-4">
            <div class="ai-card p-4 rounded-3 h-100 text-center">
                <div class="feature-icon mb-3 mx-auto"><i class="bi bi-graph-up text-success fs-2"></i></div>
                <h4 class="fw-bold text-white mb-3">Ph√¢n T√≠ch Th√≥i Quen</h4>
                <p class="text-white-50">Hi·ªÉu r√µ gu √¢m nh·∫°c c·ªßa b·∫°n qua l·ªãch s·ª≠.</p>
                <button class="btn btn-success w-100 mt-3" onclick="analyzeHabits()"><i class="bi bi-person-lines-fill me-2"></i>Ph√¢n t√≠ch</button>
            </div>
        </div>
        <div class="col-md-4">
            <div class="ai-card p-4 rounded-3 h-100 text-center">
                <div class="feature-icon mb-3 mx-auto"><i class="bi bi-chat-left-text text-warning fs-2"></i></div>
                <h4 class="fw-bold text-white mb-3">Tr·ª£ L√Ω √Çm Nh·∫°c</h4>
                <p class="text-white-50">Chat v·ªõi AI ƒë·ªÉ ƒë∆∞·ª£c t∆∞ v·∫•n tr·ª±c ti·∫øp.</p>
                <button class="btn btn-warning w-100 mt-3" onclick="openChatAssistant()"><i class="bi bi-robot me-2"></i>Tr√≤ chuy·ªán</button>
            </div>
        </div>
    </div>

    <div class="ai-card p-5 rounded-3 mb-5 d-none" id="advanced-form">
        <h3 class="fw-bold text-white mb-4 border-bottom border-secondary pb-3">
            <i class="bi bi-sliders text-info me-2"></i>C·∫•u H√¨nh Playlist Chi Ti·∫øt
        </h3>
        <form id="aiCustomForm">
            <div class="row g-4">

                <div class="col-md-12">
                    <label class="form-label text-info fw-bold">M√¥ t·∫£ mong mu·ªën (Prompt)</label>
                    <textarea class="form-control" rows="2" placeholder="VD: Nh·∫°c Rock th·∫≠p ni√™n 90 nƒÉng l∆∞·ª£ng cao ƒë·ªÉ ch·∫°y b·ªô..." id="customDescription"></textarea>
                </div>

                <div class="col-md-6">
                    <label class="form-label text-white fw-bold">Th·ªÉ lo·∫°i ∆∞u ti√™n</label>
                    <select class="form-select" id="customGenres" multiple style="height: 100px;">
                        <option th:each="g : ${genres}" th:value="${g.name}" th:text="${g.name}"></option>
                    </select>
                    <small class="text-muted">Gi·ªØ Ctrl ƒë·ªÉ ch·ªçn nhi·ªÅu</small>
                </div>
                <div class="col-md-6">
                    <label class="form-label text-white fw-bold">Ngh·ªá sƒ© y√™u th√≠ch (c√°ch nhau d·∫•u ph·∫©y)</label>
                    <input type="text" class="form-control" id="customArtists" placeholder="VD: Son Tung M-TP, Den Vau...">

                    <div class="mt-3">
                        <label class="form-label text-white fw-bold">Ng√¥n ng·ªØ</label>
                        <select class="form-select" id="customLanguage">
                            <option value="">T·∫•t c·∫£</option>
                            <option value="Vietnamese">Ti·∫øng Vi·ªát</option>
                            <option value="English">Ti·∫øng Anh</option>
                            <option value="Korean">Ti·∫øng H√†n</option>
                        </select>
                    </div>
                </div>

                <div class="col-md-4">
                    <label class="form-label text-white fw-bold">NƒÉng l∆∞·ª£ng (Energy)</label>
                    <select class="form-select" id="minEnergy">
                        <option value="">Ng·∫´u nhi√™n</option>
                        <option value="30">Th·∫•p (Chill/Sad)</option>
                        <option value="60">Trung b√¨nh (Pop/Ballad)</option>
                        <option value="80">Cao (Rock/EDM)</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label text-white fw-bold">Nh·ªãp ƒë·ªô (BPM)</label>
                    <select class="form-select" id="minBpm">
                        <option value="">Ng·∫´u nhi√™n</option>
                        <option value="60">Ch·∫≠m (< 80 BPM)</option>
                        <option value="100">V·ª´a (100 - 120 BPM)</option>
                        <option value="130">Nhanh (> 130 BPM)</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label text-white fw-bold">NƒÉm ph√°t h√†nh</label>
                    <div class="input-group">
                        <input type="number" class="form-control" id="minYear" placeholder="T·ª´ nƒÉm">
                        <input type="number" class="form-control" id="maxYear" placeholder="ƒê·∫øn nƒÉm">
                    </div>
                </div>

                <div class="col-md-4">
                    <label class="form-label text-white fw-bold">Ho·∫°t ƒë·ªông</label>
                    <select class="form-select" id="customActivity">
                        <option value="">-- Ch·ªçn --</option>
                        <option value="studying">üìö H·ªçc t·∫≠p</option>
                        <option value="workout">üí™ T·∫≠p gym</option>
                        <option value="party">üéâ Ti·ªác t√πng</option>
                        <option value="sleep">üò¥ Ng·ªß</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <label class="form-label text-white fw-bold">S·ªë l∆∞·ª£ng b√†i: <span id="songCountValue" class="text-info">10</span></label>
                    <input type="range" class="form-range" min="5" max="50" value="10" id="songCount">
                </div>
                <div class="col-md-4">
                    <label class="form-label text-white fw-bold">ƒê√°nh gi√° t·ªëi thi·ªÉu</label>
                    <div class="star-rating fs-4">
                        <i class="bi bi-star-fill active" data-val="1"></i>
                        <i class="bi bi-star-fill active" data-val="2"></i>
                        <i class="bi bi-star-fill active" data-val="3"></i>
                        <i class="bi bi-star-fill" data-val="4"></i>
                        <i class="bi bi-star-fill" data-val="5"></i>
                    </div>
                    <input type="hidden" id="minRating" value="3">
                </div>

                <div class="col-12 border-top border-secondary pt-3">
                    <div class="d-flex gap-4 justify-content-center">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="excludeListened">
                            <label class="form-check-label text-white-50">Lo·∫°i b√†i ƒë√£ nghe</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="excludeExplicit">
                            <label class="form-check-label text-white-50">B·ªè n·ªôi dung nh·∫°y c·∫£m</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" id="onlyLikedArtists">
                            <label class="form-check-label text-white-50">Ch·ªâ ngh·ªá sƒ© ƒë√£ th√≠ch</label>
                        </div>
                    </div>
                </div>

                <div class="col-12 text-center mt-4">
                    <button type="button" class="btn btn-info btn-lg px-5 rounded-pill" onclick="submitCustomRequest()">
                        <i class="bi bi-magic me-2"></i>T·∫°o Playlist Ngay
                    </button>
                    <button type="button" class="btn btn-outline-secondary ms-3 rounded-pill" onclick="closeAdvancedForm()">H·ªßy</button>
                </div>
            </div>
        </form>
    </div>

    <div class="ai-card p-5 rounded-3 d-none" id="results-section">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h3 class="fw-bold text-white mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>K·∫øt Qu·∫£ G·ª£i √ù</h3>
                <p class="text-white-50" id="result-description">Playlist ƒë∆∞·ª£c t·∫°o theo y√™u c·∫ßu c·ªßa b·∫°n</p>
            </div>
            <button class="btn btn-outline-info" onclick="openAdvancedModal()"><i class="bi bi-arrow-repeat me-2"></i>Th·ª≠ l·∫°i</button>
        </div>

        <div class="row row-cols-2 row-cols-md-4 row-cols-lg-5 g-4" id="ai-results-list">
        </div>
    </div>

    <div class="modal fade" id="chatModal" tabindex="-1" aria-hidden="true" style="color: black;">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-dark text-white border-info">
                <div class="modal-header border-bottom border-secondary">
                    <h5 class="modal-title text-info"><i class="bi bi-robot me-2"></i>Tr·ª£ L√Ω √Çm Nh·∫°c</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="chat-box-container" id="chatMessages">
                        <div class="msg msg-ai">Ch√†o b·∫°n! T√¥i c√≥ th·ªÉ gi√∫p g√¨ cho b·∫°n h√¥m nay? (T√¨m nh·∫°c, h·ªèi v·ªÅ ngh·ªá sƒ©...)</div>
                    </div>
                </div>
                <div class="modal-footer border-top border-secondary">
                    <input type="text" class="form-control" placeholder="Nh·∫≠p c√¢u h·ªèi..." id="chatInput" onkeypress="if(event.key==='Enter') sendChatMessage()">
                    <button class="btn btn-info" onclick="sendChatMessage()"><i class="bi bi-send"></i></button>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="analysisModal" tabindex="-1" aria-hidden="true" style="color: black;">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content bg-dark text-white border-success">
                <div class="modal-header border-bottom border-secondary">
                    <h5 class="modal-title text-success"><i class="bi bi-graph-up me-2"></i>B√°o C√°o Th√≥i Quen Nghe Nh·∫°c</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div id="analysisLoading" class="text-center py-5">
                        <div class="spinner-border text-success" role="status"></div>
                        <p class="mt-2 text-white-50">AI ƒëang ƒë·ªçc l·ªãch s·ª≠ nghe nh·∫°c c·ªßa b·∫°n...</p>
                    </div>
                    <div id="analysisContent" class="analysis-content d-none p-3">
                    </div>
                </div>
                <div class="modal-footer border-top border-secondary">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
                </div>
            </div>
        </div>
    </div>

</div>

<th:block layout:fragment="extra-js">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        const API = '/api';
        const USER_ID = localStorage.getItem('music_user_id') || 1;
        // Bi·∫øn to√†n c·ª•c l∆∞u k·∫øt qu·∫£ AI (ƒë·∫∑t c√πng ch·ªó khai b√°o const API)
        let aiSongsData = [];

        // --- UI Logic ---
        document.getElementById('songCount').addEventListener('input', function() {
            document.getElementById('songCountValue').textContent = this.value;
        });

        // Star Rating Logic
        document.querySelectorAll('.star-rating i').forEach(star => {
            star.addEventListener('click', function() {
                const val = this.getAttribute('data-val');
                document.getElementById('minRating').value = val;
                document.querySelectorAll('.star-rating i').forEach(s => {
                    s.classList.toggle('active', s.getAttribute('data-val') <= val);
                });
            });
        });

        function openAdvancedModal() {
            document.getElementById('advanced-form').classList.remove('d-none');
            document.getElementById('results-section').classList.add('d-none');
            document.getElementById('advanced-form').scrollIntoView({behavior: 'smooth'});
        }
        function closeAdvancedForm() {
            document.getElementById('advanced-form').classList.add('d-none');
        }

        function quickMood(mood) {
            const moodsMap = {
                'happy': 'vui v·∫ª, t√≠ch c·ª±c', 'chill': 'th∆∞ gi√£n, acoustic',
                'energetic': 's√¥i ƒë·ªông, EDM', 'focus': 't·∫≠p trung, piano',
                'romantic': 'l√£ng m·∫°n, t√¨nh c·∫£m', 'workout': 't·∫≠p gym, bass m·∫°nh'
            };
            document.getElementById('customDescription').value = `Nh·∫°c ${moodsMap[mood]}`;
            // Set default values for quick mood
            if(mood === 'workout') document.getElementById('minEnergy').value = 80;
            if(mood === 'chill') document.getElementById('minEnergy').value = 30;

            openAdvancedModal();
        }

        // --- SUBMIT FULL DTO ---
        async function submitCustomRequest() {
            // 1. Thu th·∫≠p d·ªØ li·ªáu t·ª´ form
            const description = document.getElementById('customDescription').value;
            const genres = Array.from(document.getElementById('customGenres').selectedOptions).map(opt => opt.value);
            const artistInput = document.getElementById('customArtists').value;
            const artists = artistInput ? artistInput.split(',').map(s => s.trim()) : [];

            const req = {
                description: description,
                moods: description ? [description] : [],
                genres: genres,
                artists: artists,
                activity: document.getElementById('customActivity').value,
                language: document.getElementById('customLanguage').value,

                minEnergy: document.getElementById('minEnergy').value ? parseInt(document.getElementById('minEnergy').value) : null,
                minBpm: document.getElementById('minBpm').value ? parseInt(document.getElementById('minBpm').value) : null,

                minYear: document.getElementById('minYear').value ? parseInt(document.getElementById('minYear').value) : null,
                maxYear: document.getElementById('maxYear').value ? parseInt(document.getElementById('maxYear').value) : null,

                songCount: parseInt(document.getElementById('songCount').value),
                minRating: parseFloat(document.getElementById('minRating').value),

                excludeListened: document.getElementById('excludeListened').checked,
                excludeExplicit: document.getElementById('excludeExplicit').checked,
                onlyLikedArtists: document.getElementById('onlyLikedArtists').checked
            };

            if (!req.description && req.genres.length === 0 && !req.activity) {
                return alert("Vui l√≤ng nh·∫≠p m√¥ t·∫£ ho·∫∑c ch·ªçn th·ªÉ lo·∫°i/ho·∫°t ƒë·ªông!");
            }

            // UI Loading
            const btn = document.querySelector('button[onclick="submitCustomRequest()"]');
            const originalHtml = btn.innerHTML;
            btn.innerHTML = '<span class="spinner-border spinner-border-sm"></span> ƒêang x·ª≠ l√Ω...';
            btn.disabled = true;

            try {
                const res = await fetch(`${API}/gemini/advanced-recommend`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(req)
                });

                if(!res.ok) throw new Error("API Error");
                const songs = await res.json();
                displayResults(songs, req.description || "G·ª£i √Ω t√πy ch·ªânh");

            } catch (e) {
                console.error(e);
                alert("L·ªói khi g·ªçi AI: " + e.message);
            } finally {
                btn.innerHTML = originalHtml;
                btn.disabled = false;
            }
        }

        function displayResults(songs, desc) {
            closeAdvancedForm();
            document.getElementById('results-section').classList.remove('d-none');
            document.getElementById('result-description').textContent = `K·∫øt qu·∫£ cho: "${desc}" (${songs.length} b√†i)`;

            aiSongsData = songs; // L∆∞u v√†o bi·∫øn to√†n c·ª•c

            const container = document.getElementById('ai-results-list');
            if(songs.length === 0) {
                container.innerHTML = '<div class="text-white text-center w-100 py-5">Kh√¥ng t√¨m th·∫•y b√†i h√°t.</div>';
                return;
            }

            container.innerHTML = songs.map((song, index) => {
                const artistName = song.artist ? song.artist.name : 'Unknown';
                const songImg = song.imageUrl || '/images/default.png';

                return `
        <div class="col">
            <div class="card bg-dark border-secondary h-100 text-white">
                <div style="position: relative; cursor: pointer; overflow:hidden;" class="song-cover"
                     onclick="playAiSong(${index})"> <img src="${songImg}" class="card-img-top" style="aspect-ratio: 1/1; object-fit: cover; transition:0.3s;">

                    <div class="position-absolute top-0 start-0 w-100 h-100 d-flex align-items-center justify-content-center"
                         style="background:rgba(0,0,0,0.4); opacity:0; transition:0.3s;"
                         onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0">
                        <i class="bi bi-play-circle-fill fs-1 text-info"></i>
                    </div>
                </div>
                <div class="card-body p-2">
                    <h6 class="card-title text-truncate mb-0" title="${song.title}">
                         <a href="/songs/${song.songId}" class="text-white text-decoration-none hover-cyan">${song.title}</a>
                    </h6>
                    <small class="text-white-50 text-truncate d-block">${artistName}</small>
                </div>
            </div>
        </div>`;
            }).join('');
        }

        // --- H√ÄM PH√ÅT NH·∫†C M·ªöI CHO AI DJ ---
        function playAiSong(index) {
            const s = aiSongsData[index];
            if (!s) return;

            console.log("ƒêang ph√°t (AI):", s); // Ki·ªÉm tra log

            // T√¨m link nh·∫°c (Fallback nhi·ªÅu tr∆∞·ªùng h·ª£p)
            const musicUrl = s.filePath;
            const imgUrl = s.coverImage || '/images/default.png';
            const artist = (s.artist && s.artist.name) ? s.artist.name : 'Unknown';

            if (!musicUrl) {
                alert("L·ªói: B√†i h√°t n√†y ch∆∞a c√≥ link nh·∫°c (musicUrl null)!");
                return;
            }

            playGlobalSong(musicUrl, s.title, artist, imgUrl);
        }



        // --- 1. LOGIC PH√ÇN T√çCH TH√ìI QUEN (M·ªöI) ---
        async function analyzeHabits() {
            // M·ªü modal
            const modal = new bootstrap.Modal(document.getElementById('analysisModal'));
            modal.show();

            // Reset giao di·ªán loading
            document.getElementById('analysisLoading').classList.remove('d-none');
            document.getElementById('analysisContent').classList.add('d-none');

            try {
                // G·ªçi API: POST /api/gemini/analyze-listening-habits/{userId}
                const res = await fetch(`${API}/gemini/analyze-listening-habits/${USER_ID}`, {
                    method: 'POST'
                });

                if (!res.ok) throw new Error("L·ªói k·∫øt n·ªëi Server");

                const text = await res.text(); // AI tr·∫£ v·ªÅ Text (Markdown ho·∫∑c Plain text)

                // Hi·ªÉn th·ªã k·∫øt qu·∫£
                document.getElementById('analysisLoading').classList.add('d-none');
                const contentDiv = document.getElementById('analysisContent');
                contentDiv.classList.remove('d-none');

                // Format ƒë∆°n gi·∫£n xu·ªëng d√≤ng th√†nh <br> n·∫øu AI tr·∫£ v·ªÅ plain text
                contentDiv.innerHTML = text.replace(/\n/g, '<br>');

            } catch (e) {
                console.error(e);
                document.getElementById('analysisLoading').classList.add('d-none');
                document.getElementById('analysisContent').classList.remove('d-none');
                document.getElementById('analysisContent').innerHTML = `<p class="text-danger">Kh√¥ng th·ªÉ ph√¢n t√≠ch. H√£y ch·∫Øc ch·∫Øn b·∫°n ƒë√£ nghe v√†i b√†i h√°t ƒë·ªÉ c√≥ l·ªãch s·ª≠!</p>`;
            }
        }

        // --- 2. LOGIC CHAT ASSISTANT (FIX L·ªñI USER ID) ---
        function openChatAssistant() {
            new bootstrap.Modal(document.getElementById('chatModal')).show();
        }

        async function sendChatMessage() {
            const input = document.getElementById('chatInput');
            const message = input.value.trim();
            if (!message) return;

            const chatBox = document.getElementById('chatMessages');

            // 1. Hi·ªán tin nh·∫Øn User
            chatBox.innerHTML += `<div class="msg msg-user">${message}</div>`;
            input.value = '';
            chatBox.scrollTop = chatBox.scrollHeight;

            // 2. Hi·ªán Loading
            const loadingId = 'loading-' + Date.now();
            chatBox.innerHTML += `<div id="${loadingId}" class="msg msg-ai"><i class="spinner-border spinner-border-sm"></i> ƒêang suy nghƒ©...</div>`;
            chatBox.scrollTop = chatBox.scrollHeight;

            try {
                // [QUAN TR·ªåNG] G·ª≠i k√®m userId trong body request
                const payload = {
                    message: message,
                    history: [], // N·∫øu mu·ªën chat ng·ªØ c·∫£nh, c·∫ßn l∆∞u m·∫£ng history global
                    userId: USER_ID // <-- C·∫¶N TH√äM C√ÅI N√ÄY
                };

                const res = await fetch(`${API}/gemini/chat`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(payload)
                });

                const reply = await res.text();

                // 3. X√≥a loading, hi·ªán tin nh·∫Øn AI
                document.getElementById(loadingId).remove();
                chatBox.innerHTML += `<div class="msg msg-ai">${reply}</div>`;

            } catch (e) {
                document.getElementById(loadingId).innerHTML = `<span class="text-danger">L·ªói k·∫øt n·ªëi AI.</span>`;
            }
            chatBox.scrollTop = chatBox.scrollHeight;
        }

    </script>
</th:block>
</html>